# Caddyfile for Carrick Toolbox
# Handles SPA routing for /tool/:id deep links

toolbox.carrick.local {
    root * /var/www/toolbox
    file_server

    # Handle API routes
    handle /api/* {
        respond "API endpoint" 200
    }

    # Handle /tool/:id routes - serve index.html
    handle_path /tool/* {
        rewrite * /index.html
        file_server
    }

    handle_path /tools/* {
        rewrite * /index.html
        file_server
    }

    # Default handling - try files, fallback to index.html
    handle {
        try_files {path} /index.html
        file_server
    }

    # Enable gzip compression
    encode gzip

    # Cache static assets
    header /*.js {
        Cache-Control "public, max-age=31536000, immutable"
    }
    header /*.css {
        Cache-Control "public, max-age=31536000, immutable"
    }
}

# Production domain
tools.example.com {
    root * /var/www/toolbox
    file_server

    handle_path /tool/* {
        rewrite * /index.html
        file_server
    }

    handle_path /tools/* {
        rewrite * /index.html
        file_server
    }

    handle {
        try_files {path} /index.html
        file_server
    }

    encode gzip
    header /*.js {
        Cache-Control "public, max-age=31536000, immutable"
    }
    header /*.css {
        Cache-Control "public, max-age=31536000, immutable"
    }
}
